import{_ as U,d as B,u as S,r as n,c as T,I as $,J as D,b as P,w as F,n as N,q as R,e as f,f as s,g as j,v as q,t as L,z as V,K as x,o as h}from"./index.29837664.js";import{a as A}from"./image.60eb776a.js";import{i as G}from"./validation.8d3fc97a.js";const J=B({name:"PublishPost",components:{},setup(){const e=S(),a=n([]),b=T(()=>{const t=e.getters["user/followerList"];return t.forEach(o=>{console.log(o.id._id),a.value.push(o.id._id)}),t}),w="https://safe-brushlands-13562.herokuapp.com",k=$(),_=D(w,{path:"/socket.io/connect",transports:["websocket"],autoConnect:!0,secure:!0,transports:["websocket"],reconnection:!0,reconnectionAttempts:5,reconnectionDelay:2e3,reconnectionDelayMax:1e4,query:{Authorization:`Bearer ${k}`}}),i=async()=>{_.emit("updatePost")},d={noContent:"\u6C92\u6709\u8CBC\u6587\u5167\u5BB9\uFF0C\u8ACB\u586B\u5BEB",imageSizeError:"\u5716\u7247\u6A94\u6848\u904E\u5927\uFF0C\u50C5\u9650 1mb \u4EE5\u4E0B\u6A94\u6848",imageTypeError:"\u5716\u7247\u683C\u5F0F\u932F\u8AA4\uFF0C\u50C5\u9650 JPG\u3001PNG \u5716\u7247"};let r=P({}),c=P({name:"",thumbnail:null,size:null,unit:"KB"}),C=n(""),p=n(""),I=n(null),m=n(!1),y=n(""),u=n(!1),v=n("");const z=t=>{r=t.target.files[0],c.name=r.name,c.thumbnail=window.URL.createObjectURL(r),c.size=~~(r.size*.001),C.value=c.name,I.value=URL.createObjectURL(r),c.size>1e3?(m.value=!0,y.value=d.imageSizeError):G(c.name)?m.value=!1:(m.value=!0,y.value=d.imageTypeError)};let M=async()=>{var t,o;try{const g={file:r,title:C.value,description:p.value},l=await A(g);return console.log(l),(o=(t=l==null?void 0:l.data)==null?void 0:t.data)==null?void 0:o.link}catch(g){console.log(g)}};const E=async()=>{var t;try{if(e.dispatch("ui/toggleLoading",!0),u.value=!1,p.value==="")return u.value=!0,v.value=d.noContent,!1;if(m.value)return!1;let o="";r!=null&&r.size&&(o=await M());const g=(t=e.getters["user/userInfo"])==null?void 0:t.id,{status:l,data:re}=await e.dispatch("post/addPost",{userId:g,tags:"test",type:"person",content:p.value,image:o});l==="success"&&i(),l==="success"&&x.push({path:"/home"})}catch(o){console.log("create post error",o)}finally{e.dispatch("ui/toggleLoading",!1)}};return F(p,t=>{t===""?(u.value=!0,v.value=d.noContent):u.value=!1}),N(()=>{u.value=!0,v.value=d.noContent}),R(()=>{_.close()}),{errorImageMessageVised:m,errorImageMessage:y,errorContentMessageVised:u,errorContentMessage:v,content:p,preViewImage:I,followerIdList:a,storeFollowerList:b,showFile:z,submitPost:E,submitImage:M}}}),K=s("div",{class:"block-title"}," \u5F35\u8CBC\u52D5\u614B ",-1),O={class:"draft-post"},H={class:"draft-post__post"},Q=s("p",{class:"draft-post__post__label"},"\u8CBC\u6587\u5167\u5BB9",-1),W={class:"draft-post__textarea"},X={style:{"margin-top":"16px"}},Y=s("label",{for:"upload",class:"text-btn black"},"\u4E0A\u50B3\u5716\u7247",-1),Z=["src"],ee={key:1,class:"draft-post__img"},te={key:2,class:"error-message"},se={key:3,class:"error-message"},oe={style:{"max-width":"323px",margin:"0 auto"}};function ae(e,a,b,w,k,_){return h(),f("div",null,[K,s("div",O,[s("div",H,[Q,s("div",W,[j(s("textarea",{"onUpdate:modelValue":a[0]||(a[0]=i=>e.content=i),type:"text",name:"nickname",placeholder:"\u8F38\u5165\u60A8\u7684\u8CBC\u6587\u5167\u5BB9\u7A31"},null,512),[[q,e.content]])])]),s("div",X,[Y,s("input",{id:"upload",style:{visibility:"hidden"},type:"file",accept:"image/png, image/gif, image/jpeg",onChange:a[1]||(a[1]=(...i)=>e.showFile&&e.showFile(...i))},null,32)]),e.preViewImage?(h(),f("img",{key:0,class:"draft-post__img",style:{"margin-top":"16px"},src:e.preViewImage},null,8,Z)):(h(),f("div",ee)),e.errorImageMessageVised?(h(),f("p",te,L(e.errorImageMessage),1)):V("",!0),e.errorContentMessageVised?(h(),f("p",se,L(e.errorContentMessage),1)):V("",!0),s("div",oe,[s("button",{style:{"margin-top":"32px"},class:"btn secondary",onClick:a[2]||(a[2]=(...i)=>e.submitPost&&e.submitPost(...i))}," \u9001\u51FA\u8CBC\u6587 ")])])])}var ce=U(J,[["render",ae]]);export{ce as default};
